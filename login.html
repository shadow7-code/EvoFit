<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script>
    (function() {
      try {
        const state = JSON.parse(localStorage.getItem('evoFitApp') || '{}');
        if (state.theme === 'light') {
          document.documentElement.setAttribute('data-theme', 'light');
        }
      } catch (error) {
        localStorage.removeItem('evoFitApp');
      }
    })();
  </script>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root {
      --login-frame-bg: #2c2e43;
      --login-frame-border: #1a1a2e;
      --login-glass-bg: rgba(0, 0, 0, 0.25);
      --login-input-bg: rgba(0, 0, 0, 0.1);
      --login-input-color: #ffffff;
      --login-placeholder: #999999;
    }

    [data-theme="light"] {
      --login-frame-bg: #ffffff;
      --login-frame-border: #e5e7eb;
      --login-glass-bg: rgba(255, 255, 255, 0.9);
      --login-input-bg: rgba(255, 255, 255, 0.9);
      --login-input-color: #1a1a1a;
      --login-placeholder: #666666;
    }

    /* Navigation Bar */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--nav-bg);
      backdrop-filter: blur(10px);
      padding: 1rem 2rem;
      box-shadow: var(--shadow);
      z-index: 2000;
      transition: all 0.3s ease;
    }

    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--accent-color);
      text-decoration: none;
      transition: transform 0.3s ease;
    }

    .logo:hover {
      transform: scale(1.05);
    }

    .nav-links {
      display: flex;
      gap: 2rem;
      align-items: center;
      list-style: none;
    }

    .nav-links a {
      color: var(--text-primary);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
      padding: 0.5rem 1rem;
      border-radius: 8px;
    }

    .nav-links a:hover {
      color: var(--accent-color);
      background: var(--bg-secondary);
    }

    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-primary);
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .nav-links {
        position: fixed;
        top: 70px;
        left: -100%;
        flex-direction: column;
        background: rgba(15, 23, 42, 0.95);
        width: 100%;
        padding: 2rem;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
        transition: left 0.3s ease;
        gap: 1rem;
      }

      .nav-links.active {
        left: 0;
      }

      .mobile-menu-btn {
        display: block;
      }

      .navbar {
        padding: 1rem;
      }
    }
    @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap");

    * {margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif;}

    body {
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh;
      background: var(--bg-primary); 
      color: var(--text-primary);
      padding: 20px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    @property --a { syntax: "<angle>"; inherits: false; initial-value: 0deg; }

    .box {
      position: relative; 
      width: 450px; 
      height: auto;
      min-height: 500px;
      background: repeating-conic-gradient(from var(--a), #8A8AFF 0%, #8A8AFF 5%, transparent 5%, transparent 40%, #8A8AFF 50%);
      filter: drop-shadow(0 15px 50px #000);
      animation: rotating 4s linear infinite;
      border-radius: 20px; 
      display: flex; 
      justify-content: center; 
      align-items: center;
    }

    @keyframes rotating { 
      0%{--a:0deg;} 
      100%{--a:360deg;} 
    }

    .box::before {
      content: ""; position: absolute; width: 100%; height: 100%;
      background: repeating-conic-gradient(from var(--a), #8A8AFF 0%, #8A8AFF 5%, transparent 5%, transparent 40%, #8A8AFF 50%);
      filter: drop-shadow(0 15px 50px #000);
      border-radius: 20px; 
      animation: rotating 4s linear infinite; 
      animation-delay: -1s;
    }
    .box::after {
      content: ""; position: absolute; inset: 4px;
      background: var(--login-frame-bg); 
      border-radius: 15px; border: 8px solid var(--login-frame-border); 
    }

    .login {
      position: absolute; 
      inset: 40px; 
      display: flex; 
      justify-content: center; 
      align-items: center;
      border-radius: 10px; 
      flex-direction: column; 
      background: var(--login-glass-bg);
      z-index: 1000; 
      box-shadow: inset 0 10px 20px rgba(0,0,0,0.5);
      border-bottom: 2px solid rgba(255,255,255,0.5);
      color: var(--text-primary); 
      overflow: hidden;
    }

    .loginBx {
      position: relative; 
      display: flex; 
      justify-content: center; 
      align-items: center;
      flex-direction: column; 
      gap: 20px; 
      width: 80%; 
      max-width: 300px;
    }

    .loginBx h2 { 
      text-transform: uppercase; 
      letter-spacing: 0.2em; 
      font-weight: 600; 
      font-size: 1.3rem;
      text-align: center;
    }
    .loginBx h2 i {
      color: #8A8AFF; 
      text-shadow: 0 0 5px #8A8AFF, 0 0 30px #8A8AFF; 
    }

    .loginBx input {
      width: 100%; 
      padding: 10px 20px; 
      outline: none; 
      font-size: 1em;
      color: var(--login-input-color); 
      background: var(--login-input-bg);
      border: 2px solid var(--border-color); 
      border-radius: 30px;
    }
    .loginBx input::placeholder { color: var(--login-placeholder); }

    .loginBx input[type="submit"] {
      background: #8A8AFF; 
      border: none; 
      font-weight: 500; 
      color: #111;
      cursor: pointer; 
      transition: 0.5s;
    }
    .loginBx input[type="submit"]:hover {
      box-shadow: 0 0 10px #8A8AFF, 0 0 60px #8A8AFF; 
    }

    .rememberBtn {
      padding: 10px 20px;
      border-radius: 30px;
      border: 2px solid #8A8AFF;
      background: transparent;
      color: #8A8AFF;
      font-weight: 500;
      cursor: pointer;
      transition: 0.4s;
      width: 100%;
      text-align: center;
      font-size: 1em;
    }
    .rememberBtn.active {
      background: #8A8AFF;
      color: #111;
      box-shadow: 0 0 10px #8A8AFF, 0 0 40px #8A8AFF;
    }

    .group { 
      display: flex; 
      width: 100%; 
      justify-content: space-between; 
      font-size: 0.9rem;
    }
    .group a { color: #fff; text-decoration: none; }
    .group a:nth-child(2) {
      color: #8A8AFF; 
      font-weight: 600;
    }

    #suggestions {
      background: #2C2E43; 
      border: 1px solid #555;
      border-radius: 6px; 
      margin-top: 5px; 
      width: 100%;
      display: none; 
      flex-direction: column;
      max-height: 120px; 
      overflow-y: auto; 
      z-index: 2000; 
      position: absolute;
      top: 100%;
    }
    #suggestions div {
      padding: 8px; 
      cursor: pointer; 
      color: #fff;
    }
    #suggestions div:hover { background: #444; }

    .welcomeMsg {
      background: rgba(138, 138, 255, 0.2);
      border: 1px solid #8A8AFF;
      border-radius: 10px;
      padding: 10px 15px;
      margin-bottom: 10px;
      text-align: center;
      color: #8A8AFF;
      font-size: 0.9rem;
      display: none;
    }

    .signOutBtn {
      padding: 8px 20px;
      border-radius: 30px;
      border: 2px solid #ff6b6b;
      background: transparent;
      color: #ff6b6b;
      font-weight: 500;
      cursor: pointer;
      transition: 0.4s;
      width: 100%;
      text-align: center;
      font-size: 0.9em;
      display: none;
      margin-top: -10px;
    }
    .signOutBtn:hover {
      background: #ff6b6b;
      color: #fff;
      box-shadow: 0 0 10px #ff6b6b, 0 0 40px #ff6b6b;
    }

    .clearBtn {
      background: transparent;
      border: 2px solid #ff6b6b;
      color: #ff6b6b;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: 0.4s;
      font-weight: 500;
      margin-top: 10px;
    }
    .clearBtn:hover {
      background: #ff6b6b;
      color: #fff;
      box-shadow: 0 0 10px #ff6b6b;
    }

    /* Mobile Responsiveness */
    @media (max-width: 500px) {
      .box {
        width: 95%;
        min-height: 480px;
      }
      .login {
        inset: 30px;
      }
      .loginBx {
        width: 90%;
        gap: 18px;
      }
      .loginBx h2 {
        font-size: 1.1rem;
        letter-spacing: 0.15em;
      }
      .loginBx input {
        padding: 10px 18px;
        font-size: 0.95em;
      }
      .rememberBtn {
        font-size: 0.95em;
        padding: 10px 18px;
      }
      .group {
        flex-direction: column;
        align-items: center;
        gap: 10px;
        font-size: 0.85rem;
      }
      #suggestions {
        max-height: 100px;
      }
    }

    @media (max-width: 350px) {
      .box {
        width: 100%;
        min-height: 450px;
      }
      .login {
        inset: 25px;
      }
      .loginBx h2 {
        font-size: 1rem;
      }
      .loginBx input {
        padding: 9px 16px;
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="logo">EvoFit</a>
      <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
      <ul class="nav-links" id="navLinks">
        <li><a href="index.html#home">Home</a></li>
        <li id="dashboardLink" style="display: none;"><a href="dashboard.html">Workout</a></li>
        <li><a href="diet.html">Diet</a></li>
        <li><a href="support.html">About</a></li>
        <li><a href="support.html#contact">Contact</a></li>
        <li><a href="login.html" id="loginLink">Login</a></li>
        <li><button class="theme-toggle" id="themeToggle">‚òÄÔ∏è</button></li>
        <li class="profile-container" id="profileContainer" style="display: none;">
          <div class="profile-dropdown">
            <button class="profile-btn" id="profileBtn">üë§</button>
            <div class="profile-menu" id="profileMenu">
              <div class="profile-header">
                <span class="profile-username" id="profileUsername">User</span>
              </div>
              <hr class="profile-divider">
              <a href="profile.html" class="profile-link">View Profile</a>
              <button class="profile-logout" onclick="logoutUser()">Logout</button>
            </div>
          </div>
        </li>
      </ul>
    </div>
  </nav>

<div class="box" style="margin-top: 80px;">
  <div class="login">
    <div class="loginBx">
      <h2><i class="fa-solid fa-right-to-bracket"></i> Login <i class="fa-solid fa-heart"></i></h2>

      <div id="welcomeMsg" class="welcomeMsg"></div>

      <button id="signOutBtn" class="signOutBtn" onclick="signOut()">Sign Out</button>

      <div style="position:relative; width:100%;">
        <input type="text" id="username" placeholder="Username" autocomplete="off">
        <div id="suggestions"></div>
      </div>

      <input type="password" id="password" placeholder="Password">

      <button id="rememberBtn" class="rememberBtn">Remember Me</button>

      <input type="submit" value="Sign in" onclick="loginUser()" />

      <div class="group">
        <a href="#">Forgot Password</a>
        <a href="#">Sign up</a>
      </div>

      <button class="clearBtn" onclick="clearAllData()">Clear All Data</button>
    </div>
  </div>
</div>

<script src="app-storage.js"></script>
<script src="script.js"></script>
<script>
  const rememberBtn = document.getElementById("rememberBtn");
  const usernameInput = document.getElementById("username");
  const passwordInput = document.getElementById("password");
  const suggestionsBox = document.getElementById("suggestions");
  const welcomeMsg = document.getElementById("welcomeMsg");
  const signOutBtn = document.getElementById("signOutBtn");
  const signInBtn = document.querySelector('input[type="submit"]');
  const formActions = document.querySelector('.group');
  const redirectTarget = new URLSearchParams(window.location.search).get('redirect') || 'dashboard.html';

  let remember = false;

  function getUsersMap() {
    return window.EvoFitStorage?.readState?.().users || {};
  }

  function findUser(username) {
    if (!username) return null;
    const users = getUsersMap();
    return users[username] || null;
  }

  function getAllUsernames() {
    return Object.keys(getUsersMap());
  }

  function setRememberedUser(username) {
    if (remember) {
      window.EvoFitStorage?.setRememberedUser?.(username);
    } else {
      window.EvoFitStorage?.setRememberedUser?.(null);
    }
  }

  function showBanner(message) {
    welcomeMsg.textContent = message;
    welcomeMsg.style.display = "block";
  }

  function hideBanner() {
    welcomeMsg.style.display = "none";
  }

  function toggleForm(enabled) {
    const displayValue = enabled ? "block" : "none";
    usernameInput.style.display = displayValue;
    passwordInput.style.display = displayValue;
    rememberBtn.style.display = displayValue;
    signInBtn.style.display = displayValue;
    if (formActions) {
      formActions.style.display = enabled ? "flex" : "none";
    }
  }

  function completeLogin(username, showFeedback = true) {
    if (showFeedback) {
      showBanner(`Welcome ${username}! Taking you to your plan...`);
    }

    setTimeout(() => {
      window.location.replace(redirectTarget);
    }, showFeedback ? 600 : 0);
  }

  function loginUser(showFeedback = true) {
    const activeUsername = window.EvoFitAuth?.getActiveUsername?.();
    if (activeUsername) {
      showBanner(`Already logged in as ${activeUsername}`);
      toggleForm(false);
      signOutBtn.style.display = "block";
      return;
    }

    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();

    if (!username || !password) {
      alert("Please enter both username and password!");
      return;
    }

    const existing = findUser(username);

    if (existing && existing.password && existing.password !== password) {
      alert("Wrong password!");
      return;
    }

    window.EvoFitStorage?.setUserPassword?.(username, password);
    setRememberedUser(username);

    sessionStorage.setItem('activeSession', JSON.stringify({
      username,
      loginTime: Date.now()
    }));
    sessionStorage.setItem('isLoggedIn', 'true');

    toggleForm(false);
    signOutBtn.style.display = "block";
    completeLogin(username, showFeedback);
  }

  function showLoggedInState(username) {
    toggleForm(false);
    signOutBtn.style.display = "block";
    showBanner(`Already logged in as ${username}`);
  }

  function signOut() {
    if (!confirm("Are you sure you want to sign out?")) {
      return;
    }

    window.EvoFitAuth?.clearSession?.();
    window.EvoFitStorage?.setRememberedUser?.(null);
    remember = false;
    rememberBtn.classList.remove("active");

    usernameInput.value = "";
    passwordInput.value = "";
    hideBanner();
    signOutBtn.style.display = "none";
    toggleForm(true);
  }

  function clearAllData() {
    if (!confirm("This will delete ALL saved usernames, passwords, and plans. Continue?")) {
      return;
    }

    localStorage.removeItem('evoFitApp');
    sessionStorage.removeItem('activeSession');
    sessionStorage.removeItem('isLoggedIn');
    localStorage.removeItem('userInfo');
    localStorage.removeItem('dietPlan');
    localStorage.removeItem('workoutHistory');
    window.location.reload();
  }

  function showSuggestions() {
    const query = usernameInput.value.toLowerCase();
    const filtered = getAllUsernames()
      .filter(name => name.toLowerCase().includes(query))
      .map(name => ({ username: name, password: findUser(name)?.password || '' }));

    suggestionsBox.innerHTML = "";
    if (filtered.length === 0) {
      suggestionsBox.style.display = "none";
      return;
    }

    suggestionsBox.style.display = "flex";
    filtered.forEach(user => {
      const div = document.createElement("div");
      div.textContent = user.username;
      div.onclick = () => {
        usernameInput.value = user.username;
        passwordInput.value = user.password || "";
        suggestionsBox.style.display = "none";
      };
      suggestionsBox.appendChild(div);
    });
  }

  usernameInput.addEventListener("focus", showSuggestions);
  usernameInput.addEventListener("input", showSuggestions);

  document.addEventListener("click", (e) => {
    if (!usernameInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
      suggestionsBox.style.display = "none";
    }
  });

  passwordInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      loginUser();
    }
  });

  rememberBtn.addEventListener("click", () => {
    remember = !remember;
    rememberBtn.classList.toggle("active", remember);
  });

  window.addEventListener("load", () => {
    const activeUsername = window.EvoFitAuth?.getActiveUsername?.();
    if (activeUsername) {
      showLoggedInState(activeUsername);
      return;
    }

    const rememberedUser = window.EvoFitStorage?.getRememberedUser?.();
    if (rememberedUser) {
      const user = findUser(rememberedUser);
      if (user) {
        usernameInput.value = rememberedUser;
        passwordInput.value = user.password || "";
        remember = true;
        rememberBtn.classList.add("active");
      }
    }
  });
</script>

</body>
</html>